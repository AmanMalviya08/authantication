
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
   
    <style>
        .status-present {
            color: #28a745;
            font-weight: bold;
        }
        .status-absent {
            color: #dc3545;
            font-weight: bold;
        }
        .status-leave {
            color: #ffc107;
            font-weight: bold;
        }
        .action-btn {
            margin-right: 5px;
        }
    </style>

    <div class="container">
        <h1 class="text-center my-4">Attendance Management</h1>
        
        <!-- Mark Attendance Card -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title">Mark Attendance</h3>
            </div>
            <div class="card-body">
                <form id="attendanceForm">
                    <div class="mb-3">
                        <label for="studentSelect" class="form-label">Student</label>
                        <select class="form-select" id="studentSelect" required>
                            <option value="" selected disabled>Loading students...</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dateInput" class="form-label">Date</label>
                        <input type="text" class="form-control" id="dateInput" placeholder="Select date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="present" value="present" checked>
                            <label class="form-check-label" for="present">Present</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="absent" value="absent">
                            <label class="form-check-label" for="absent">Absent</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="leave" value="leave">
                            <label class="form-check-label" for="leave">Leave</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="facultySelect" class="form-label">Marked By</label>
                        <select class="form-select" id="facultySelect" required>
                            <option value="" selected disabled>Loading faculty...</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>

        <!-- Attendance Records Card -->
        <div class="card shadow mt-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Attendance Records</h3>
                <div id="recordStats" class="text-white">
                    <span id="totalRecords">0</span> records
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="attendanceTable">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Marked By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data loaded dynamically -->
                            <tr>
                                <td colspan="5" class="text-center">Loading records...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editStudent" class="form-label">Student</label>
                            <select class="form-select" id="editStudent" required>
                                <option value="" selected disabled>Select Student</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editDate" class="form-label">Date</label>
                            <input type="text" class="form-control" id="editDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="editStatus" id="editPresent" value="present">
                                <label class="form-check-label" for="editPresent">Present</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="editStatus" id="editAbsent" value="absent">
                                <label class="form-check-label" for="editAbsent">Absent</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="editStatus" id="editLeave" value="leave">
                                <label class="form-check-label" for="editLeave">Leave</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editFaculty" class="form-label">Marked By</label>
                            <select class="form-select" id="editFaculty" required>
                                <option value="" selected disabled>Select Faculty</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
                <!-- Main JavaScript -->
                <script>
                    document.addEventListener("DOMContentLoaded", () => {
                        // Fetch attendance data when the page loads
                        fetchAttendanceData();
                
                        async function fetchAttendanceData() {
                            try {
                                const response = await fetch('/api/attendance'); // Fetch from backend API
                                const data = await response.json();
                
                                if (data.length === 0) {
                                    document.querySelector("#attendanceTable tbody").innerHTML = "<tr><td colspan='5' class='text-center'>No records found</td></tr>";
                                } else {
                                    // Clear the loading message
                                    document.querySelector("#attendanceTable tbody").innerHTML = "";
                                    
                                    // Iterate through the data and create rows dynamically
                                    data.forEach(record => {
                                        const row = document.createElement("tr");
                                        row.innerHTML = `
                                            <td>${record.studentName}</td>
                                            <td>${record.date}</td>
                                            <td>${record.status}</td>
                                            <td>${record.markedBy}</td>
                                            <td>
                                                <!-- You can add actions like edit or delete here -->
                                                <button class="btn btn-danger btn-sm">Delete</button>
                                            </td>
                                        `;
                                        document.querySelector("#attendanceTable tbody").appendChild(row);
                                    });
                
                                    // Update the total records count
                                    document.querySelector("#totalRecords").textContent = data.length;
                                }
                            } catch (error) {
                                console.error("Error fetching attendance data:", error);
                                document.querySelector("#attendanceTable tbody").innerHTML = "<tr><td colspan='5' class='text-center'>Error loading records</td></tr>";
                            }
                        }
                    });
                
                
                document.addEventListener('DOMContentLoaded', function() {
                    // Check authentication
                    const token = localStorage.getItem('userToken');
                    const userId = localStorage.getItem('userId');
                    const userRole = localStorage.getItem('userRole');
                    
                    if (!token) {
                        window.location.href = '/login.html';
                        return;
                    }

                    // Initialize date pickers
                    flatpickr("#dateInput", { dateFormat: "Y-m-d", defaultDate: new Date() });
                    flatpickr("#editDate", { dateFormat: "Y-m-d" });

                    // DOM Elements
                    const studentSelect = document.getElementById('studentSelect');
                    const facultySelect = document.getElementById('facultySelect');
                    const attendanceForm = document.getElementById('attendanceForm');
                    const attendanceTable = document.querySelector('#attendanceTable tbody');
                    const totalRecordsSpan = document.getElementById('totalRecords');

                    // Initialize data
                    let students = [];
                    let faculty = [];
                    let attendanceRecords = [];

                    // API Base URL - Update this with your actual backend URL
                    const API_BASE_URL = 'http://localhost:5000/api'; // Change this to your actual API base URL

                    // Fetch initial data
                    Promise.all([fetchStudents(), fetchFaculty(), fetchAttendance()])
                        .then(([studentsData, facultyData, attendanceData]) => {
                            students = studentsData;
                            faculty = facultyData;
                            attendanceRecords = attendanceData;
                            populateDropdowns();
                            renderAttendanceTable();
                            updateStats();
                        })
                        .catch(error => {
                            console.error('Error loading initial data:', error);
                            alert('Failed to load initial data');
                        });

                    // Fetch students from API
                    async function fetchStudents() {
                        try {
                            const response = await fetch(`${API_BASE_URL}/student`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (!response.ok) throw new Error('Failed to fetch students');
                            return await response.json();
                        } catch (error) {
                            console.error('Error fetching students:', error);
                            return [];
                        }
                    }

                    // Fetch faculty from API
                    async function fetchFaculty() {
                        try {
                            const response = await fetch(`${API_BASE_URL}/faculty`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (!response.ok) throw new Error('Failed to fetch faculty');
                            return await response.json();
                        } catch (error) {
                            console.error('Error fetching faculty:', error);
                            return [];
                        }
                    }

                    // Fetch attendance records
                    async function fetchAttendance() {
                        try {
                            // If faculty role, only fetch records marked by this faculty
                            let url = `${API_BASE_URL}/attendance`;
                            if (userRole === 'faculty') {
                                url = `${API_BASE_URL}/attendance?markedBy=${userId}`;
                            }
                            
                            const response = await fetch(url, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (!response.ok) throw new Error('Failed to fetch attendance');
                            return await response.json();
                        } catch (error) {
                            console.error('Error fetching attendance:', error);
                            return [];
                        }
                    }

                    // Update statistics
                    function updateStats() {
                        totalRecordsSpan.textContent = attendanceRecords.length;
                    }

                    // Populate dropdowns
                    function populateDropdowns() {
                        // Student dropdowns
                        studentSelect.innerHTML = '<option value="" selected disabled>Select Student</option>';
                        students.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student._id;
                            option.textContent = student.name;
                            studentSelect.appendChild(option);
                        });

                        // Faculty dropdowns
                        facultySelect.innerHTML = '<option value="" selected disabled>Select Faculty</option>';
                        
                        // If admin, show all faculty
                        if (userRole === 'admin') {
                            faculty.forEach(facultyMember => {
                                const option = document.createElement('option');
                                option.value = facultyMember._id;
                                option.textContent = facultyMember.name;
                                facultySelect.appendChild(option);
                            });
                        } 
                        // If faculty, only show the logged-in faculty and pre-select it
                        else if (userRole === 'faculty') {
                            const loggedInFaculty = faculty.find(f => f._id === userId);
                            if (loggedInFaculty) {
                                const option = document.createElement('option');
                                option.value = loggedInFaculty._id;
                                option.textContent = loggedInFaculty.name;
                                option.selected = true;
                                facultySelect.appendChild(option);
                                
                                // Disable the select if not admin
                                facultySelect.disabled = true;
                            }
                        }

                        // Edit dropdowns
                        const editStudent = document.getElementById('editStudent');
                        if (editStudent) {
                            editStudent.innerHTML = '<option value="" selected disabled>Select Student</option>';
                            students.forEach(student => {
                                const option = document.createElement('option');
                                option.value = student._id;
                                option.textContent = student.name;
                                editStudent.appendChild(option);
                            });
                        }

                        const editFaculty = document.getElementById('editFaculty');
                        if (editFaculty) {
                            editFaculty.innerHTML = '<option value="" selected disabled>Select Faculty</option>';
                            
                            // Similar logic for edit faculty dropdown
                            if (userRole === 'admin') {
                                faculty.forEach(facultyMember => {
                                    const option = document.createElement('option');
                                    option.value = facultyMember._id;
                                    option.textContent = facultyMember.name;
                                    editFaculty.appendChild(option);
                                });
                            } else if (userRole === 'faculty') {
                                const loggedInFaculty = faculty.find(f => f._id === userId);
                                if (loggedInFaculty) {
                                    const option = document.createElement('option');
                                    option.value = loggedInFaculty._id;
                                    option.textContent = loggedInFaculty.name;
                                    option.selected = true;
                                    editFaculty.appendChild(option);
                                    
                                    // Disable the select if not admin
                                    editFaculty.disabled = true;
                                }
                            }
                        }
                    }

                    // Render attendance table
                    function renderAttendanceTable() {
                        attendanceTable.innerHTML = '';
                        
                        // If no records found
                        if (attendanceRecords.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = '<td colspan="5" class="text-center">No attendance records found</td>';
                            attendanceTable.appendChild(row);
                            return;
                        }
                        
                        attendanceRecords.forEach(record => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${record.student?.name || 'Unknown'}</td>
                                <td>${new Date(record.date).toLocaleDateString()}</td>
                                <td class="status-${record.status}">${record.status.charAt(0).toUpperCase() + record.status.slice(1)}</td>
                                <td>${record.markedBy?.name || 'Unknown'}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning action-btn edit-btn" data-id="${record._id}">Edit</button>
                                    <button class="btn btn-sm btn-danger action-btn delete-btn" data-id="${record._id}">Delete</button>
                                </td>
                            `;
                            attendanceTable.appendChild(row);
                        });

                        // Add event listeners
                        document.querySelectorAll('.edit-btn').forEach(btn => {
                            btn.addEventListener('click', handleEdit);
                        });

                        document.querySelectorAll('.delete-btn').forEach(btn => {
                            btn.addEventListener('click', handleDelete);
                        });
                    }

                    // Handle form submission
                    attendanceForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        // Get selected faculty (if faculty role, use logged-in user ID)
                        const selectedFacultyId = userRole === 'faculty' ? userId : facultySelect.value;
                        
                        const formData = {
                            student: studentSelect.value,
                            date: document.getElementById('dateInput').value,
                            status: document.querySelector('input[name="status"]:checked').value,
                            markedBy: selectedFacultyId
                        };

                        try {
                            const response = await fetch(`${API_BASE_URL}/attendance`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify(formData)
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Failed to save attendance');
                            }

                            const newRecord = await response.json();
                            attendanceRecords.push(newRecord);
                            renderAttendanceTable();
                            updateStats();
                            attendanceForm.reset();
                            
                            // Reset date picker to today
                            flatpickr("#dateInput", { dateFormat: "Y-m-d", defaultDate: new Date() });
                            
                            // If faculty role, reselect the faculty in dropdown
                            if (userRole === 'faculty' && facultySelect) {
                                facultySelect.value = userId;
                            }
                            
                            alert('Attendance recorded successfully!');
                        } catch (error) {
                            console.error('Error:', error);
                            alert(`Error: ${error.message}`);
                        }
                    });

                    // Handle edit button click
                    async function handleEdit(e) {
                        const recordId = e.target.dataset.id;
                        try {
                            const response = await fetch(`${API_BASE_URL}/attendance/${recordId}`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (!response.ok) throw new Error('Failed to fetch record');
                            const record = await response.json();

                            // Populate edit form
                            document.getElementById('editId').value = record._id;
                            document.getElementById('editStudent').value = record.student._id;
                            document.getElementById('editDate').value = record.date.split('T')[0];
                            document.querySelector(`input[name="editStatus"][value="${record.status}"]`).checked = true;
                            
                            // For faculty role, preset and disable faculty selector
                            if (userRole === 'faculty') {
                                document.getElementById('editFaculty').value = userId;
                                document.getElementById('editFaculty').disabled = true;
                            } else {
                                document.getElementById('editFaculty').value = record.markedBy._id;
                                document.getElementById('editFaculty').disabled = false;
                            }

                            // Show modal
                            new bootstrap.Modal(document.getElementById('editModal')).show();
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Failed to load record for editing');
                        }
                    }

                    // Handle save changes
                    document.getElementById('saveChangesBtn').addEventListener('click', async () => {
                        const recordId = document.getElementById('editId').value;
                        
                        // Get selected faculty (if faculty role, use logged-in user ID)
                        const selectedFacultyId = userRole === 'faculty' ? userId : document.getElementById('editFaculty').value;
                        
                        const formData = {
                            student: document.getElementById('editStudent').value,
                            date: document.getElementById('editDate').value,
                            status: document.querySelector('input[name="editStatus"]:checked').value,
                            markedBy: selectedFacultyId
                        };

                        try {
                            const response = await fetch(`${API_BASE_URL}/attendance/${recordId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify(formData)
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Failed to update record');
                            }

                            const updatedRecord = await response.json();
                            const index = attendanceRecords.findIndex(r => r._id === recordId);
                            attendanceRecords[index] = updatedRecord;
                            renderAttendanceTable();
                            updateStats();
                            
                            // Close modal
                            const modalElement = document.getElementById('editModal');
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            modalInstance.hide();
                            
                            alert('Attendance updated successfully!');
                        } catch (error) {
                            console.error('Error:', error);
                            alert(`Error: ${error.message}`);
                        }
                    });

                    // Handle delete
                    async function handleDelete(e) {
                        if (!confirm('Are you sure you want to delete this record?')) return;
                        
                        const recordId = e.target.dataset.id;
                        try {
                            const response = await fetch(`${API_BASE_URL}/attendance/${recordId}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Failed to delete record');
                            }

                            attendanceRecords = attendanceRecords.filter(r => r._id !== recordId);
                            renderAttendanceTable();
                            updateStats();
                            alert('Record deleted successfully!');
                        } catch (error) {
                            console.error('Error:', error);
                            alert(`Error: ${error.message}`);
                        }
                    }

                    // Check if user is unauthorized or token expired
                    function checkUnauthorized(response) {
                        if (response.status === 401) {
                            alert('Your session has expired. Please login again.');
                            localStorage.removeItem('userToken');
                            localStorage.removeItem('userId');
                            localStorage.removeItem('userRole');
                            window.location.href = '/login.html';
                            return true;
                        }
                        return false;
                    }
                });
                </script>
