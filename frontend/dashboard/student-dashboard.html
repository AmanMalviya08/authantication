<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard</title>
    <!-- <link rel="stylesheet" href="../css/admin.css" />
    <link rel="stylesheet" href="../css/hod.css" /> -->
    <link rel="stylesheet" href="faculty.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  </head>

  <body>
    <div class="main-content">
      <header>
        <h1>
          <i class="fas fa-tachometer-alt"></i>
          Dashboard
        </h1>
        <div class="user-wrapper">
          <div>
            <h4>Student User</h4>
          </div>
        </div>
        <div class="logout">
          <a href="/frontend/dashboard/index.html?logout=true" id="logoutLink">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </div>
      </header>

      <main>
        <div class="cards">
          <div class="card-single" data-type="student">
            <div>
              <h1 id="student-count">Students</h1>
            </div>
            <div><i class="fas fa-users"></i></div>
          </div>
          <div class="card-single" data-type="student">
            <div>
              <h1 id="student-count">Assignments</h1>
            </div>
            <div><i class="fas fa-users"></i></div>
          </div>

          <!-- <div class="card-single" data-type="Attendance"> -->
          <!-- Mark Attendance Card -->
          <div
            class="card shadow"
            id="openAttendanceModal"
            style="cursor: pointer">
            <div class="card-header bg-primary text-white">
              <h3 class="card-title">Mark Attendance</h3>
            </div>
            <div class="card-body text-center">
              <p>Click here to mark attendance</p>
            </div>
          </div>
        </div>

        <div class="recent-grid">
          <div class="projects">
            <div class="card">
              <div class="card-header">
                <h3 id="recent-title" style="text-align: center; width: 100%">
                  Recent Students
                </h3>
              </div>

              <div class="card-body">
                <div
                  class="top-actions"
                  style="
                    margin-bottom: 10px;
                    display: flex;
                    justify-content: space-between;
                  ">
                  <button
                    id="toggle-edit-mode"
                    style="
                      background-color: #3554d1;
                      color: white;
                      border: none;
                      padding: 6px 12px;
                      font-size: 14px;
                      border-radius: 4px;
                      cursor: pointer;
                      display: inline-flex;
                      align-items: center;
                      gap: 5px;
                    ">
                    Edit All <i class="fas fa-edit"></i>
                  </button>
                </div>

                <div class="table-responsive">
                  <table width="100%">
                    <thead>
                      <tr>
                        <td></td>
                        <td>ID</td>
                        <td>Name</td>
                        <td>Department</td>
                        <td>Status</td>
                        <td>Actions</td>
                      </tr>
                    </thead>
                    <tbody id="recent-body">
                      <!-- Filled by JavaScript -->
                    </tbody>
                  </table>
                </div>

                <div id="bulk-actions" style="display: none; margin-top: 10px">
                  <button
                    id="delete-selected"
                    style="
                      background-color: #dc3545;
                      color: white;
                      padding: 6px 12px;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 14px;
                    ">
                    Delete Selected
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Permissions Section -->

        <!-- Department Performance Section -->
      </main>
    </div>

    <!-- Compact Create/Edit User Modal -->
    <div id="user-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 id="modal-title">Add New User</h2>
        <form id="user-form">
          <input type="hidden" id="user-id" />
          <div class="form-row">
            <div class="form-group">
              <label for="user-role">Role</label>
              <select id="user-role" required>
                <option value="student">Student</option>
                <option value="faculty">Faculty</option>
                <option value="hod">HOD</option>
              </select>
            </div>
            <div class="form-group">
              <label for="user-status">Status</label>
              <select id="user-status" required>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="pending">Pending</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="user-name">Full Name</label>
            <input
              type="text"
              id="user-name"
              placeholder="Enter full name"
              required />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="user-email">Email</label>
              <input
                type="email"
                id="user-email"
                placeholder="Enter email"
                required />
            </div>
            <div class="form-group">
              <label for="user-department">Department</label>
              <select id="user-department" required>
                <option value="">Select Department</option>
                <option value="Computer Science">CS</option>
                <option value="Electrical Engineering">EE</option>
                <option value="Mechanical Engineering">ME</option>
                <option value="Civil Engineering">CE</option>
                <option value="Information Technology">IT</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="user-password">Password</label>
            <input
              type="password"
              id="user-password"
              placeholder="Enter password"
              required />
          </div>
          <div class="form-buttons">
            <button type="button" id="cancel-form" class="btn-secondary">
              Cancel
            </button>
            <button type="submit" id="save-user" class="btn-primary">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="container">
      <!-- Mark Attendance Modal -->
      <div
        class="modal fade"
        id="attendanceModal"
        tabindex="-1"
        aria-labelledby="attendanceModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="attendanceModalLabel">
                Mark Attendance
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <form id="attendanceForm">
                <div class="mb-3">
                  <label for="studentSelect" class="form-label">Student</label>
                  <select class="form-select" id="studentSelect" required>
                    <option value="" selected disabled>
                      Loading students...
                    </option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="dateInput" class="form-label">Date</label>
                  <input
                    type="date"
                    class="form-control"
                    id="dateInput"
                    required />
                </div>

                <div class="mb-3">
                  <label class="form-label">Status</label><br />
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      id="present"
                      value="present"
                      checked />
                    <label class="form-check-label" for="present"
                      >Present</label
                    >
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      id="absent"
                      value="absent" />
                    <label class="form-check-label" for="absent">Absent</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      id="leave"
                      value="leave" />
                    <label class="form-check-label" for="leave">Leave</label>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="facultySelect" class="form-label"
                    >Marked By</label
                  >
                  <select class="form-select" id="facultySelect" required>
                    <option value="" selected disabled>
                      Loading faculty...
                    </option>
                  </select>
                </div>

                <div class="text-end">
                  <button type="submit" class="btn btn-primary">Submit</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="editModalLabel">Edit Attendance</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <input type="hidden" id="editId" />
              <div class="mb-3">
                <label for="editStudent" class="form-label">Student</label>
                <select class="form-select" id="editStudent" required>
                  <option value="" selected disabled>
                    Loading students...
                  </option>
                </select>
              </div>

              <div class="mb-3">
                <label for="editDate" class="form-label">Date</label>
                <input
                  type="text"
                  class="form-control"
                  id="editDate"
                  required />
              </div>

              <div class="mb-3">
                <label class="form-label">Status</label>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="editStatus"
                    id="editPresent"
                    value="present" />
                  <label class="form-check-label" for="editPresent"
                    >Present</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="editStatus"
                    id="editAbsent"
                    value="absent" />
                  <label class="form-check-label" for="editAbsent"
                    >Absent</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="editStatus"
                    id="editLeave"
                    value="leave" />
                  <label class="form-check-label" for="editLeave">Leave</label>
                </div>
              </div>

              <div class="mb-3">
                <label for="editFaculty" class="form-label">Marked By</label>
                <select class="form-select" id="editFaculty" required>
                  <option value="" selected disabled>Loading faculty...</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveChangesBtn">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="card shadow mt-4"></div>

    <div class="container">
      <h1>Submit Assignment</h1>

      <div id="successMessage" class="success-message">
        Assignment submitted successfully!
      </div>

      <div class="assignment-info">
        <h2 id="assignmentTitle">Assignment Title</h2>
        <p id="assignmentDescription">Description will appear here</p>
        <p><strong>Subject:</strong> <span id="assignmentSubject"></span></p>
        <p>
          <strong>Department:</strong> <span id="assignmentDepartment"></span>
        </p>
        <p><strong>Semester:</strong> <span id="assignmentSemester"></span></p>
        <p><strong>Max Marks:</strong> <span id="assignmentMaxMarks"></span></p>
        <p class="deadline">
          <strong>Due Date:</strong> <span id="assignmentDueDate"></span>
        </p>
      </div>

      <form id="submissionForm">
        <div class="form-group">
            <input type="hidden" id="assignmentId" value="YOUR_ASSIGNMENT_ID_HERE" />
          <label>Upload Assignment File</label>
          <div class="file-upload" id="fileUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag & drop your file here or click to browse</p>
            <span id="fileName">No file selected</span>
            <input
              type="file"
              id="fileInput"
              accept=".pdf,.doc,.docx,.txt,.zip" />
          </div>
          <div id="fileError" class="error"></div>
        </div>

        <div class="form-group">
          <label for="comments">Additional Comments (Optional)</label>
          <textarea id="comments" name="comments" rows="4"></textarea>
        </div>

        <button type="submit" class="btn btn-block">Submit Assignment</button>
      </form>
    </div>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
      const studentSelect = document.getElementById("studentSelect");
      const facultySelect = document.getElementById("facultySelect");
      let attendanceModal = null;

      // Initialize modal once when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        attendanceModal = new bootstrap.Modal(
          document.getElementById("attendanceModal")
        );
        fetchAttendanceData();
      });

      document
        .getElementById("openAttendanceModal")
        .addEventListener("click", () => {
          attendanceModal.show();
        });

      document
        .getElementById("attendanceModal")
        .addEventListener("show.bs.modal", async () => {
          await populateDropdowns();
        });

      async function populateDropdowns() {
        const token = localStorage.getItem("userToken");
        if (!token) {
          alert("Please login to continue.");
          window.location.href = "/frontend/dashboard/index.html";
          return;
        }

        try {
          const [studentRes, facultyRes] = await Promise.all([
            fetch("http://localhost:5000/api/users/role/student", {
              headers: { Authorization: `Bearer ${token}` },
            }),
            fetch("http://localhost:5000/api/users/role/faculty", {
              headers: { Authorization: `Bearer ${token}` },
            }),
          ]);

          // Check if responses are ok before processing
          if (!studentRes.ok || !facultyRes.ok) {
            throw new Error("Failed to fetch dropdown data");
          }

          const studentData = await studentRes.json();
          const facultyData = await facultyRes.json();

          // Clear and populate student dropdown
          studentSelect.innerHTML = `<option value="" disabled selected>Select Student</option>`;
          (studentData.data || []).forEach((s) => {
            const option = document.createElement("option");
            option.value = s._id;
            option.textContent = `${s.name} (${
              s.department || s.dept || "N/A"
            })`;
            studentSelect.appendChild(option);
          });

          // Clear and populate faculty dropdown
          facultySelect.innerHTML = `<option value="" disabled selected>Select Faculty</option>`;
          (facultyData.data || []).forEach((f) => {
            const option = document.createElement("option");
            option.value = f._id;
            option.textContent = `${f.name} (${f.department || "N/A"})`;
            facultySelect.appendChild(option);
          });

          // Auto-select current user
          const currentRole = localStorage.getItem("userRole");
          const currentUserId = localStorage.getItem("userId");
          if (currentRole === "faculty") facultySelect.value = currentUserId;
          if (currentRole === "student") studentSelect.value = currentUserId;
        } catch (err) {
          console.error("Dropdown load error:", err);
          alert("Failed to load dropdown data. Please try again.");
        }
      }

      document
        .getElementById("attendanceForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const studentId = studentSelect.value;
          const facultyId = facultySelect.value;
          const date = document.getElementById("dateInput").value;
          const status = document.querySelector(
            'input[name="status"]:checked'
          )?.value;

          // Validate form inputs
          if (!studentId || !facultyId || !date || !status) {
            alert("Please fill all required fields");
            return;
          }

          const token = localStorage.getItem("userToken");
          if (!token) {
            alert("Please login to continue.");
            window.location.href = "/frontend/dashboard/index.html";
            return;
          }

          try {
            const response = await fetch(
              "http://localhost:5000/api/attendance",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ studentId, facultyId, date, status }),
              }
            );

            // Handle non-OK responses
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                errorData.message || "Failed to submit attendance"
              );
            }

            const data = await response.json();

            // Reset form and close modal
            document.getElementById("attendanceForm").reset();
            attendanceModal.hide();

            // Refresh attendance data
            await fetchAttendanceData();

            // Optional: Show success message
            alert("Attendance recorded successfully!");
          } catch (error) {
            console.error("POST error:", error);
            alert(error.message || "Error posting attendance");
          }
        });

      async function fetchAttendanceData() {
        const token = localStorage.getItem("userToken");
        if (!token) return;

        try {
          const response = await fetch("http://localhost:5000/api/attendance", {
            headers: { Authorization: `Bearer ${token}` },
          });

          // Check if response is ok before processing
          if (!response.ok) {
            throw new Error("Failed to fetch attendance data");
          }

          const data = await response.json();
          const tbody = document.querySelector("#attendanceTable tbody");
          tbody.innerHTML = "";

          if (!Array.isArray(data)) {
            throw new Error("Invalid data format received from server");
          }

          if (data.length === 0) {
            tbody.innerHTML =
              "<tr><td colspan='5' class='text-center'>No records found</td></tr>";
          } else {
            data.forEach((rec) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${rec.studentName || "N/A"}</td>
                <td>${rec.date || "N/A"}</td>
                <td>${rec.status || "N/A"}</td>
                <td>${rec.markedBy || "N/A"}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteRecord('${
                  rec._id
                }')">Delete</button></td>
              `;
              tbody.appendChild(row);
            });
            document.querySelector("#totalRecords").textContent = data.length;
          }
        } catch (error) {
          console.error("Attendance fetch error:", error);
          document.querySelector("#attendanceTable tbody").innerHTML =
            "<tr><td colspan='5' class='text-center'>Error loading records: " +
            error.message +
            "</td></tr>";
        }
      }

      window.deleteRecord = async (id) => {
        if (!confirm("Are you sure you want to delete this record?")) return;

        const token = localStorage.getItem("userToken");
        if (!token) return;

        try {
          const response = await fetch(
            `http://localhost:5000/api/attendance/${id}`,
            {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to delete record");
          }

          // Refresh the attendance data after successful deletion
          await fetchAttendanceData();
          alert("Record deleted successfully!");
        } catch (err) {
          console.error("Delete error:", err);
          alert(err.message || "Error deleting record");
        }
      };
    </script>

    <script>
      // DOM Elements
      const recentTitle = document.getElementById("recent-title");
      const recentBody = document.getElementById("recent-body");
      const modal = document.getElementById("user-modal");
      const modalTitle = document.getElementById("modal-title");
      const userForm = document.getElementById("user-form");
      const userId = document.getElementById("user-id");
      const userRole = document.getElementById("user-role");
      const userName = document.getElementById("user-name");
      const userEmail = document.getElementById("user-email");
      const userPassword = document.getElementById("user-password");
      const userDepartment = document.getElementById("user-department");
      const userStatus = document.getElementById("user-status");

      let currentType = "student";
      let editMode = false;
      let users = [];

      // Modal Handling
      function openModal(isEdit = false, userData = null) {
        userForm.reset();

        if (isEdit && userData) {
          modalTitle.textContent = "Edit User";
          userId.value = userData._id;
          userRole.value = userData.role || currentType;
          userName.value = userData.name || userData.fullName || "";
          userEmail.value = userData.email || "";
          userDepartment.value = userData.dept || userData.department || "";
          userStatus.value = userData.status || "active";

          const currentUserRole = localStorage.getItem("userRole");
          userRole.disabled = currentUserRole !== "admin";
          userPassword.placeholder =
            "Enter new password (leave empty to keep current)";
          userPassword.required = false;
        } else {
          modalTitle.textContent = "Add New User";
          userId.value = "";
          userRole.value = currentType;
          userRole.disabled = false;
          userPassword.placeholder = "Enter password";
          userPassword.required = true;
        }

        modal.style.display = "block";
      }

      function closeModal() {
        modal.style.display = "none";
        userForm.reset();
      }

      document
        .querySelector(".close-modal")
        .addEventListener("click", closeModal);
      document
        .getElementById("cancel-form")
        .addEventListener("click", closeModal);
      window.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      // Form Submission
      userForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = {
          role: userRole.value,
          email: userEmail.value,
          status: userStatus.value,
        };

        if (userRole.value === "student") {
          formData.name = userName.value;
          formData.dept = userDepartment.value;
        } else {
          formData.fullName = userName.value;
          formData.department = userDepartment.value;
        }

        if (userPassword.value) formData.password = userPassword.value;

        const isEditing = userId.value !== "";
        const endpoint = isEditing
          ? `http://localhost:5000/api/users/${userId.value}`
          : "http://localhost:5000/api/auth/register";
        const method = isEditing ? "PUT" : "POST";

        try {
          const token = localStorage.getItem("userToken");
          if (!token) {
            alert("Please login to continue.");
            return (window.location.href = "/frontend/dashboard/index.html");
          }

          const response = await fetch(endpoint, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(formData),
          });

          const data = await response.json();
          if (!response.ok) throw new Error(data.message || "Operation failed");

          alert(`User ${isEditing ? "updated" : "created"} successfully`);
          closeModal();
          displayRecentData(currentType);
        } catch (err) {
          alert(`Error: ${err.message}`);
          console.error(err);
        }
      });

      // Fetch Data by Role
      async function fetchData(type) {
        try {
          const token = localStorage.getItem("userToken");
          if (!token) {
            alert("Please login to continue.");
            window.location.href = "/frontend/dashboard/index.html";
            return [];
          }

          const res = await fetch(
            `http://localhost:5000/api/users/role/${type}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (res.status === 401) {
            alert("Session expired. Please login again.");
            return (window.location.href = "/frontend/dashboard/index.html");
          }

          if (!res.ok) throw new Error("Failed to fetch users");

          const result = await res.json();
          return result.data || [];
        } catch (err) {
          console.error(err);
          recentBody.innerHTML = `<tr><td colspan="6">Error loading data</td></tr>`;
          return [];
        }
      }

      // Display Table
      async function displayRecentData(type) {
        currentType = type;
        recentTitle.textContent = `Recent ${capitalizeFirstLetter(type)}s`;
        recentBody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

        try {
          users = await fetchData(type);
          if (!users.length) {
            return (recentBody.innerHTML =
              "<tr><td colspan='6'>No data found</td></tr>");
          }

          recentBody.innerHTML = "";
          users.forEach((user, i) => {
            const row = document.createElement("tr");
            row.innerHTML = createRow(user, i);
            recentBody.appendChild(row);
          });

          document.querySelectorAll(".btn-edit").forEach((btn) => {
            btn.addEventListener("click", () => {
              const id = btn.dataset.id;
              const user = users.find((u) => u._id === id);
              openModal(true, user);
            });
          });

          document.querySelectorAll(".btn-delete").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.dataset.id;
              if (confirm("Delete this user?")) await deleteUser(id);
            });
          });

          setupSelectAllCheckbox();
        } catch (err) {
          recentBody.innerHTML =
            "<tr><td colspan='6'>Error loading data</td></tr>";
        }
      }

      // Row Markup
      function createRow(user, index) {
        return `
                                  <td>${
                                    editMode
                                      ? `<input type="checkbox" class="user-checkbox" data-id="${user._id}" />`
                                      : ""
                                  }</td>
                                  <td>${index + 1}</td>
                                  <td>${
                                    user.name || user.fullName || "N/A"
                                  }</td>
                                  <td>${
                                    user.dept || user.department || "N/A"
                                  }</td>
                                  <td><span class="status ${
                                    user.status || "active"
                                  }">${user.status || "active"}</span></td>
                                  <td>
                                    <div class="action-buttons">
                                      <button class="btn-primary btn-sm btn-edit" data-id="${
                                        user._id
                                      }">
                                        <i class="fas fa-edit"></i>
                                      </button>
                                      <button class="btn-primary btn-sm btn-delete" data-id="${
                                        user._id
                                      }">
                                        <i class="fas fa-trash"></i>
                                      </button>
                                    </div>
                                  </td>
                                `;
      }

      // Delete Single User
      async function deleteUser(id) {
        try {
          const token = localStorage.getItem("userToken");
          if (!token) {
            alert("Please login.");
            return (window.location.href = "/frontend/dashboard/index.html");
          }

          const res = await fetch(`http://localhost:5000/api/users/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Delete failed");

          alert(data.message || "User deleted");
          displayRecentData(currentType);
        } catch (err) {
          alert(`Error: ${err.message}`);
          console.error(err);
        }
      }

      // Bulk Delete
      document
        .getElementById("delete-selected")
        .addEventListener("click", async () => {
          const selectedIds = Array.from(
            document.querySelectorAll(".user-checkbox:checked")
          ).map((cb) => cb.dataset.id);

          if (!selectedIds.length) return alert("No users selected");
          if (!confirm("Delete selected users?")) return;

          try {
            const token = localStorage.getItem("userToken");
            const res = await fetch(
              "http://localhost:5000/api/users/bulk-delete",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ ids: selectedIds }),
              }
            );

            const data = await res.json();
            if (!res.ok) throw new Error(data.message || "Bulk delete failed");

            alert(data.message || "Users deleted");
            displayRecentData(currentType);
          } catch (err) {
            alert(`Error: ${err.message}`);
            console.error(err);
          }
        });

      // Select All Handling
      function setupSelectAllCheckbox() {
        const selectAll = document.getElementById("select-all");
        if (!selectAll) return;
        selectAll.checked = false;
        selectAll.addEventListener("change", (e) => {
          document
            .querySelectorAll(".user-checkbox")
            .forEach((cb) => (cb.checked = e.target.checked));
        });
      }

      // Utilities
      function capitalizeFirstLetter(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      // Role Filter Buttons
      document.querySelectorAll(".card-single").forEach((card) => {
        card.addEventListener("click", () => {
          const type = card.getAttribute("data-type");
          displayRecentData(type);
        });
      });

      // Toggle Bulk Delete Mode
      document
        .getElementById("toggle-edit-mode")
        .addEventListener("click", () => {
          editMode = !editMode;
          displayRecentData(currentType);
          document.getElementById("bulk-actions").style.display = editMode
            ? "block"
            : "none";
        });

      // Initial Fetch
      window.addEventListener("DOMContentLoaded", () => {
        displayRecentData(currentType);
      });
    </script>

    <!-- assigment  -->
    <script>document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("submissionForm");
        const fileInput = document.getElementById("fileInput");
        const fileUploadArea = document.getElementById("fileUploadArea");
        const fileName = document.getElementById("fileName");
        const successMessage = document.getElementById("successMessage");
        const fileError = document.getElementById("fileError");
        const comments = document.getElementById("comments");
        const token = localStorage.getItem("token");
        const assignmentId = document.getElementById("assignmentId").value;
      
        if (!assignmentId) {
          alert("Assignment ID is missing");
          return;
        }
      
        // Fetch assignment details
        async function fetchAssignmentDetails() {
          try {
            const response = await fetch(`/api/assignments/${assignmentId}`, {
              headers: {
                "Authorization": `Bearer ${token}`
              }
            });
      
            if (!response.ok) {
              throw new Error("Failed to fetch assignment details");
            }
      
            const assignment = await response.json();
      
            document.getElementById("assignmentTitle").textContent = assignment.title || "";
            document.getElementById("assignmentDescription").textContent = assignment.description || "";
            document.getElementById("assignmentSubject").textContent = assignment.subject || "";
            document.getElementById("assignmentDepartment").textContent = assignment.department || "";
            document.getElementById("assignmentSemester").textContent = assignment.semester || "";
            document.getElementById("assignmentMaxMarks").textContent = assignment.maxMarks || "";
      
            const dueDate = new Date(assignment.dueDate);
            document.getElementById("assignmentDueDate").textContent = 
              `${dueDate.toLocaleDateString()} at ${dueDate.toLocaleTimeString()}`;
          } catch (error) {
            console.error("Error fetching assignment:", error);
            alert(error.message || "Error loading assignment");
          }
        }
      
        fetchAssignmentDetails();
      
        // File upload interactions
        fileUploadArea.addEventListener("click", () => fileInput.click());
      
        fileInput.addEventListener("change", () => {
          fileName.textContent = fileInput.files.length > 0
            ? fileInput.files[0].name
            : "No file selected";
        });
      
        fileUploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          fileUploadArea.style.borderColor = "#3498db";
          fileUploadArea.style.backgroundColor = "rgba(52, 152, 219, 0.1)";
        });
      
        fileUploadArea.addEventListener("dragleave", () => {
          fileUploadArea.style.borderColor = "#ccc";
          fileUploadArea.style.backgroundColor = "transparent";
        });
      
        fileUploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          fileUploadArea.style.borderColor = "#ccc";
          fileUploadArea.style.backgroundColor = "transparent";
      
          if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileName.textContent = fileInput.files[0].name;
          }
        });
      
        // Form submit handler
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          fileError.textContent = "";
      
          if (!fileInput.files || fileInput.files.length === 0) {
            fileError.textContent = "Please select a file to upload";
            return;
          }
      
          const file = fileInput.files[0];
          const formData = new FormData();
          formData.append("file", file);
      
          if (comments && comments.value) {
            formData.append("comments", comments.value);
          }
      
          try {
            const response = await fetch(`/api/assignments/${assignmentId}/submit`, {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${token}`
              },
              body: formData
            });
      
            if (!response.ok) {
              const contentType = response.headers.get("content-type");
              if (contentType && contentType.includes("application/json")) {
                const data = await response.json();
                throw new Error(data.message || "Failed to submit assignment");
              } else {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
              }
            }
      
            const data = await response.json();
            
            successMessage.style.display = "block";
            form.reset();
            fileName.textContent = "No file selected";
      
            setTimeout(() => {
              successMessage.style.display = "none";
            }, 5000);
          } catch (error) {
            console.error("Submission error:", error);
            alert(error.message || "An error occurred while submitting");
          }
        });
      });
    
    // To this
    document.getElementById('logoutLink')?.addEventListener('click', function(e) {
      e.preventDefault();
      logout();
    });
  
    function logout() {
      // Clear all authentication data
      localStorage.removeItem('userToken');
      localStorage.removeItem('userRole');
      localStorage.removeItem('userData');
      
      // Clear session storage if used
      sessionStorage.clear();
      
      // Clear cookies related to authentication
      document.cookie.split(";").forEach(function(c) {
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, 
          "=;expires=" + new Date().toUTCString() + ";path=/");
      });
  
      // Redirect to login page with logout parameter
      const loginUrl = '/frontend/dashboard/index.html?logout=true';
      
      // Show loading state
      showAlert('info', 'Logging out... Please wait.');
      
      // Use fetch to get the login page content
      fetch(loginUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.text();
        })
        .then(html => {
          // Replace current document with login page
          document.open();
          document.write(html);
          document.close();
          
          // Update URL without reloading
          window.history.replaceState({}, '', loginUrl);
          
          // Show success message
          const alert = document.createElement('div');
          alert.className = 'custom-alert success';
          alert.innerHTML = `
            <span>You have been logged out successfully.</span>
            <button class="close-btn">&times;</button>
          `;
          document.body.appendChild(alert);
          
          // Add event listener to close button
          alert.querySelector('.close-btn').addEventListener('click', () => {
            alert.remove();
          });
          
          // Auto-remove after 5 seconds
          setTimeout(() => {
            if (alert.parentNode) {
              alert.remove();
            }
          }, 5000);
        })
        .catch(error => {
          console.error('Logout error:', error);
          // Fallback to traditional redirect if fetch fails
          window.location.href = loginUrl;
        });
    }

    </script>
      
  </body>
</html>
